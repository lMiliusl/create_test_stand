---
- name: Локальная установка DevOps инструментов
  hosts: devops_servers
  become: yes
  gather_facts: yes
  
  tasks:
    - name: Обновление apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Установка базовых утилит
      apt:
        name:
          - git
          - curl
          - wget
          - vim
          - htop
          - net-tools
          - tree
          - jq
          - unzip
          - python3-pip
          - python3-venv
          - software-properties-common
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
        state: present

    - name: Установка Docker
      block:
        - name: Добавление Docker GPG ключа
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present

        - name: Добавление Docker репозитория
          apt_repository:
            repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
            state: present
            update_cache: yes

        - name: Установка Docker CE
          apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-buildx-plugin
            state: present

        - name: Добавление пользователя в группу docker
          user:
            name: "{{ ansible_user_id }}"
            groups: docker
            append: yes

        - name: Запуск Docker
          systemd:
            name: docker
            state: started
            enabled: yes

    - name: Установка Docker Compose
      get_url:
        url: https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64
        dest: /usr/local/bin/docker-compose
        mode: '0755'

    - name: Установка kubectl
      block:
        - name: Скачивание kubectl
          get_url:
            url: "https://dl.k8s.io/release/{{ kubectl_version }}/bin/linux/amd64/kubectl"
            dest: /tmp/kubectl
            mode: '0755'
          
        - name: Установка kubectl
          copy:
            src: /tmp/kubectl
            dest: /usr/local/bin/kubectl
            mode: '0755'
            remote_src: yes
          
        - name: Очистка временного файла
          file:
            path: /tmp/kubectl
            state: absent
      vars:
        kubectl_version: "v1.28.0"  # Можно использовать последнюю стабильную

    - name: Установка Helm
      shell: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      args:
        creates: /usr/local/bin/helm

    - name: Установка других полезных инструментов
      apt:
        name:
          - make
          - nmap
          - telnet
          - ncdu
          - ripgrep
          - bat
          - fzf
        state: present

    - name: Создание рабочих директорий
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user_id }}"
      loop:
        - /home/{{ ansible_user_id }}/projects
        - /home/{{ ansible_user_id }}/k8s
        - /home/{{ ansible_user_id }}/docker
        - /home/{{ ansible_user_id }}/terraform
        - /home/{{ ansible_user_id }}/ansible
        - /home/{{ ansible_user_id }}/.local/bin

    - name: Установка minikube (для локального Kubernetes)
      shell: |
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        sudo install minikube-linux-amd64 /usr/local/bin/minikube
        rm minikube-linux-amd64
      args:
        creates: /usr/local/bin/minikube

    - name: Установка k9s (терминальный UI для Kubernetes)
      get_url:
        url: https://github.com/derailed/k9s/releases/latest/download/k9s_Linux_amd64.tar.gz
        dest: /tmp/k9s.tar.gz
      register: k9s_download

    - name: Распаковка k9s
      unarchive:
        src: /tmp/k9s.tar.gz
        dest: /tmp
        remote_src: yes
      when: k9s_download.changed

    - name: Установка k9s бинарника
      copy:
        src: /tmp/k9s
        dest: /usr/local/bin/k9s
        mode: '0755'
        remote_src: yes
      when: k9s_download.changed

    - name: Очистка временных файлов k9s
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/k9s.tar.gz
        - /tmp/k9s
      when: k9s_download.changed

    - name: Проверка установленных версий
      block:
        - name: Получение версий
          shell: |
            echo "Docker: $(docker --version 2>/dev/null || echo 'Not installed')"
            echo "Docker Compose: $(docker-compose --version 2>/dev/null || echo 'Not installed')"
            echo "Kubectl: $(kubectl version --client --short 2>/dev/null || echo 'Not installed')"
            echo "Helm: $(helm version --short 2>/dev/null || echo 'Not installed')"
            echo "Terraform: $(terraform version -json | jq -r '.terraform_version' 2>/dev/null || echo 'Not installed')"
          register: versions
          changed_when: false

        - name: Вывод версий
          debug:
            msg: "{{ versions.stdout_lines }}"