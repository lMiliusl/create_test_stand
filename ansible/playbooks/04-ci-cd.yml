---
- name: Установка CI/CD инструментов
  hosts: devops_servers
  become: yes
  tasks:
    - name: Установка Jenkins
      apt:
        name: jenkins
        state: present
      when: install_jenkins|default(false)

    - name: Установка GitLab Runner
      shell: |
        curl -L "https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh" | bash
        apt-get install gitlab-runner

    - name: Установка Terraform
      shell: |
        wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | tee /usr/share/keyrings/hashicorp-archive-keyring.gpg
        echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/hashicorp.list
        apt update && apt install terraform

    - name: Установка Ansible (на сервере)
      apt:
        name: ansible
        state: present

    - name: Установка Packer
      shell: |
        wget https://releases.hashicorp.com/packer/1.9.4/packer_1.9.4_linux_amd64.zip
        unzip packer_1.9.4_linux_amd64.zip
        mv packer /usr/local/bin/

    - name: Установка Vault
      apt:
        name: vault
        state: present

    - name: Установка ArgoCD CLI
      shell: |
        curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
        install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
        rm argocd-linux-amd64